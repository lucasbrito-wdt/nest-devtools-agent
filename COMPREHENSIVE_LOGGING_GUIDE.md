# Comprehensive Logging System - User Guide

## üéâ Sistema Completo de Logging para NestJS DevTools

Este guia fornece instru√ß√µes completas para usar o sistema de logging abrangente que captura:

- üìÖ **Schedule/Jobs** - Tarefas agendadas e cron jobs
- üîå **HTTP Client** - Requisi√ß√µes HTTP de sa√≠da
- üíæ **Redis** - Opera√ß√µes Redis
- üë• **Sessions** - Rastreamento de sess√µes de usu√°rio
- üåê **Requests** - Requisi√ß√µes HTTP de entrada (existente)
- ‚ö†Ô∏è **Exceptions** - Exce√ß√µes e erros (existente)
- üìù **Logs** - Logs da aplica√ß√£o (existente)

## üì¶ Instala√ß√£o

### 1. Instalar o Agent

```bash
npm install nest-devtools-agent
```

### 2. Configurar no seu App NestJS

```typescript
import { Module } from '@nestjs/common';
import { DevtoolsModule } from 'nest-devtools-agent';
import { ConfigModule, ConfigService } from '@nestjs/config';

@Module({
  imports: [
    ConfigModule.forRoot({ isGlobal: true }),

    // Configura√ß√£o do DevTools
    DevtoolsModule.forRootAsync({
      inject: [ConfigService],
      useFactory: (config: ConfigService) => ({
        enabled: config.get('NODE_ENV') !== 'production',
        backendUrl: config.get('DEVTOOLS_BACKEND_URL', 'http://localhost:4000'),
        apiKey: config.get('DEVTOOLS_API_KEY', 'dev-key'),

        // Configura√ß√µes de captura
        captureHeaders: true,
        captureBody: true,
        captureResponse: true,
        captureResponseHeaders: true,
        captureSession: true,
        captureSchedule: true,
        captureHttpClient: true,
        captureRedis: true,

        // Configura√ß√£o Redis (se usar Redis)
        redisConfig: {
          host: config.get('REDIS_HOST', 'localhost'),
          port: config.get('REDIS_PORT', 6379),
          db: 0,
        },
      }),
    }),

    // Seus outros m√≥dulos...
  ],
})
export class AppModule {}
```

## üöÄ Uso dos Tracers

### 1. Schedule Tracer - Rastreamento de Jobs

```typescript
import { Injectable } from '@nestjs/common';
import { Cron } from '@nestjs/schedule';
import { ScheduleTracer } from 'nest-devtools-agent';

@Injectable()
export class TasksService {
  constructor(private readonly scheduleTracer: ScheduleTracer) {}

  @Cron('0 * * * *') // A cada hora
  async handleHourlyTask() {
    const jobId = 'hourly-cleanup';
    const jobName = 'Hourly Cleanup Task';

    // Registra in√≠cio do job
    this.scheduleTracer.trackJobStart(jobId, jobName, '0 * * * *');

    try {
      // Executa o trabalho
      const result = await this.performCleanup();

      // Registra sucesso
      this.scheduleTracer.trackJobComplete(jobId, result);
    } catch (error) {
      // Registra falha
      this.scheduleTracer.trackJobFailure(jobId, error);
    }
  }

  private async performCleanup() {
    // Sua l√≥gica aqui
    return { deletedRecords: 42 };
  }
}
```

### 2. HTTP Client Tracer - Requisi√ß√µes de Sa√≠da

#### Op√ß√£o A: Interceptar HttpService (Autom√°tico)

```typescript
import { Injectable } from '@nestjs/common';
import { HttpService } from '@nestjs/axios';
import { HttpClientTracer } from 'nest-devtools-agent';

@Injectable()
export class ExternalApiService {
  constructor(
    private readonly httpService: HttpService,
    private readonly httpClientTracer: HttpClientTracer,
  ) {
    // Intercepta automaticamente todas as requisi√ß√µes do HttpService
    this.httpClientTracer.interceptAxiosInstance(this.httpService.axiosRef);
  }

  async fetchData() {
    // Todas as requisi√ß√µes ser√£o rastreadas automaticamente
    const response = await this.httpService.get('https://api.example.com/data').toPromise();
    return response.data;
  }
}
```

#### Op√ß√£o B: Rastreamento Manual

```typescript
async fetchDataManual() {
  return this.httpClientTracer.trackCustomRequest(
    'GET',
    'https://api.example.com/data',
    async () => {
      const response = await fetch('https://api.example.com/data');
      return response.json();
    },
    {
      headers: { 'Authorization': 'Bearer token' },
    }
  );
}
```

### 3. Redis Tracer - Opera√ß√µes Redis

#### Op√ß√£o A: Interceptar Cliente Redis (Autom√°tico)

```typescript
import { Injectable, Inject } from '@nestjs/common';
import { RedisTracer } from 'nest-devtools-agent';
import { Redis } from 'ioredis';

@Injectable()
export class CacheService {
  constructor(
    @Inject('REDIS_CLIENT') private readonly redis: Redis,
    private readonly redisTracer: RedisTracer,
  ) {
    // Intercepta automaticamente todas as opera√ß√µes
    this.redisTracer.interceptRedisClient(this.redis);
  }

  async get(key: string) {
    // Opera√ß√£o rastreada automaticamente
    return this.redis.get(key);
  }

  async set(key: string, value: string) {
    // Opera√ß√£o rastreada automaticamente
    return this.redis.set(key, value);
  }
}
```

#### Op√ß√£o B: Cliente Wrapped

```typescript
constructor(
  @Inject('REDIS_CLIENT') private readonly redis: Redis,
  private readonly redisTracer: RedisTracer,
) {
  // Cria um cliente wrapped que rastreia automaticamente
  this.trackedRedis = this.redisTracer.createTrackedRedisClient(this.redis);
}

async cachedOperation() {
  await this.trackedRedis.set('key', 'value');
  const value = await this.trackedRedis.get('key');
  return value;
}
```

#### Op√ß√£o C: Rastreamento Manual

```typescript
async customOperation() {
  return this.redisTracer.trackCustomOperation(
    'CUSTOM_COMMAND',
    async () => {
      // Sua opera√ß√£o customizada
      return await this.redis.eval('...script...', 0);
    },
    {
      key: 'my-key',
      args: ['arg1', 'arg2'],
    }
  );
}
```

### 4. Session Subscriber - Rastreamento de Sess√µes

#### Op√ß√£o A: Middleware Autom√°tico (Recomendado)

```typescript
// No main.ts
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { SessionSubscriber } from 'nest-devtools-agent';
import * as session from 'express-session';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);

  // Configurar express-session
  app.use(
    session({
      secret: 'your-secret',
      resave: false,
      saveUninitialized: false,
    }),
  );

  // Adicionar middleware de rastreamento de sess√£o
  const sessionSubscriber = app.get(SessionSubscriber);
  app.use(sessionSubscriber.createSessionMiddleware());

  await app.listen(3000);
}
bootstrap();
```

#### Op√ß√£o B: Interceptar Session Store

```typescript
import RedisStore from 'connect-redis';
import { SessionSubscriber } from 'nest-devtools-agent';

const sessionStore = new RedisStore({ client: redisClient });

// Intercepta o store para rastrear automaticamente
const sessionSubscriber = app.get(SessionSubscriber);
sessionSubscriber.interceptSessionStore(sessionStore);

app.use(
  session({
    store: sessionStore,
    secret: 'your-secret',
  }),
);
```

#### Op√ß√£o C: Rastreamento Manual

```typescript
import { SessionSubscriber } from 'nest-devtools-agent';

@Injectable()
export class AuthService {
  constructor(private readonly sessionSubscriber: SessionSubscriber) {}

  async login(req: Request, userId: string) {
    const sessionId = req.session.id;

    // Registra cria√ß√£o de sess√£o
    this.sessionSubscriber.trackSessionCreated(
      sessionId,
      { userId, loginTime: new Date() },
      {
        userId,
        ip: req.ip,
        userAgent: req.get('user-agent'),
      },
    );
  }

  async logout(req: Request) {
    const sessionId = req.session.id;

    // Registra destrui√ß√£o de sess√£o
    this.sessionSubscriber.trackSessionDestroyed(sessionId, {
      userId: req.session.userId,
      ip: req.ip,
    });
  }
}
```

## üñ•Ô∏è Dashboard Frontend

### Acessar o Dashboard

1. **Iniciar o Backend:**

   ```bash
   cd packages/backend
   npm run start:dev
   ```

2. **Iniciar o Frontend:**

   ```bash
   cd packages/frontend
   npm run dev
   ```

3. **Abrir no Navegador:**
   - Dashboard: http://localhost:5173/
   - Schedule: http://localhost:5173/schedule
   - HTTP Client: http://localhost:5173/http-client
   - Redis: http://localhost:5173/redis
   - Sessions: http://localhost:5173/sessions

### Funcionalidades do Dashboard

#### üìÖ Schedule Page

- Visualizar todos os jobs agendados
- Filtrar por status (scheduled, running, completed, failed)
- Ver dura√ß√£o de execu√ß√£o
- Acompanhar pr√≥xima execu√ß√£o
- Estat√≠sticas: Total, Completados, Falhados, Taxa de Sucesso

#### üîå HTTP Client Page

- Monitorar requisi√ß√µes HTTP de sa√≠da
- Filtrar por m√©todo (GET, POST, PUT, DELETE)
- Filtrar por URL e status code
- Ver request/response completos
- Estat√≠sticas: Total, Sucesso, Falhas, Dura√ß√£o M√©dia

#### üíæ Redis Page

- Rastrear opera√ß√µes Redis
- Filtrar por comando e chave
- Ver argumentos e resultados
- Identificar opera√ß√µes lentas
- Estat√≠sticas: Total, Sucesso, Falhas, Dura√ß√£o M√©dia

#### üë• Sessions Page

- Monitorar sess√µes de usu√°rios
- Filtrar por a√ß√£o (created, updated, destroyed, accessed)
- Ver dados da sess√£o
- Rastrear usu√°rios ativos
- Estat√≠sticas: Total, Ativas, Usu√°rios √önicos, Dura√ß√£o M√©dia

## ‚öôÔ∏è Configura√ß√£o Avan√ßada

### Vari√°veis de Ambiente

```env
# Backend DevTools
DEVTOOLS_BACKEND_URL=http://localhost:4000
DEVTOOLS_API_KEY=your-secure-api-key

# Configura√ß√µes de Captura
DEVTOOLS_CAPTURE_HEADERS=true
DEVTOOLS_CAPTURE_BODY=true
DEVTOOLS_CAPTURE_RESPONSE=true
DEVTOOLS_CAPTURE_RESPONSE_HEADERS=true
DEVTOOLS_CAPTURE_SESSION=true
DEVTOOLS_CAPTURE_SCHEDULE=true
DEVTOOLS_CAPTURE_HTTP_CLIENT=true
DEVTOOLS_CAPTURE_REDIS=true

# Redis (se usar)
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0

# Database
DATABASE_URL=postgresql://user:password@localhost:5432/devtools
```

### Configura√ß√£o Granular

```typescript
DevtoolsModule.forRoot({
  enabled: true,
  backendUrl: 'http://localhost:4000',
  apiKey: 'dev-key',

  // Controle fino sobre o que capturar
  captureHeaders: true,
  captureBody: true,
  captureResponse: false, // Desabilitar se responses forem muito grandes
  captureResponseHeaders: true,

  // Limites de tamanho
  maxBodySize: 10240, // 10KB

  // Timeout e retry
  timeout: 5000,
  maxRetries: 3,

  // Buffer para quando backend est√° offline
  enableBuffer: true,
  maxBufferSize: 100,

  // Campos sens√≠veis (ser√£o redactados)
  sensitiveFields: [
    'password',
    'token',
    'secret',
    'authorization',
    'cookie',
    'api_key',
    'credit_card',
  ],

  // Capturas espec√≠ficas
  captureSession: true,
  captureSchedule: true,
  captureHttpClient: true,
  captureRedis: true,

  // Config Redis
  redisConfig: {
    host: 'localhost',
    port: 6379,
    db: 0,
  },

  // Ambiente
  environment: process.env.NODE_ENV,
});
```

## üîí Seguran√ßa

### Prote√ß√£o de Dados Sens√≠veis

O sistema automaticamente redacta campos sens√≠veis:

```typescript
// Estes campos ser√£o automaticamente redactados
const defaultSensitiveFields = [
  'password',
  'token',
  'secret',
  'authorization',
  'cookie',
  'api_key',
  'apiKey',
  'access_token',
  'refresh_token',
];

// Adicionar campos customizados
DevtoolsModule.forRoot({
  sensitiveFields: [...defaultSensitiveFields, 'ssn', 'credit_card', 'cvv'],
});
```

### Desabilitar em Produ√ß√£o

```typescript
DevtoolsModule.forRoot({
  enabled: process.env.NODE_ENV !== 'production',
  // ou
  enabled: process.env.DEVTOOLS_ENABLED === 'true',
});
```

## üìä Casos de Uso

### 1. Debugging de Jobs Lentos

```typescript
// O Schedule Tracer automaticamente captura dura√ß√£o
@Cron('*/5 * * * *')
async processQueue() {
  this.scheduleTracer.trackJobStart('queue-processor', 'Queue Processor');

  try {
    await this.processItems();
    this.scheduleTracer.trackJobComplete('queue-processor');
  } catch (error) {
    this.scheduleTracer.trackJobFailure('queue-processor', error);
  }
}

// No dashboard: Schedule > Slowest Jobs
// Identifica jobs que est√£o demorando muito
```

### 2. Monitorar APIs Externas

```typescript
// Rastreia automaticamente todas as chamadas
this.httpClientTracer.interceptAxiosInstance(this.httpService.axiosRef);

// No dashboard: HTTP Client > Status Distribution
// Veja quantas requisi√ß√µes est√£o falhando por endpoint
```

### 3. Otimizar Cache Redis

```typescript
// Rastreia todas as opera√ß√µes Redis
this.redisTracer.interceptRedisClient(this.redis);

// No dashboard: Redis > Most Accessed Keys
// Identifica keys mais acessadas para otimiza√ß√£o
```

### 4. An√°lise de Sess√µes

```typescript
// Rastreia ciclo de vida completo
app.use(sessionSubscriber.createSessionMiddleware());

// No dashboard: Sessions > Longest Sessions
// Identifica sess√µes anormalmente longas
```

## üêõ Troubleshooting

### Eventos n√£o aparecem no dashboard

1. Verificar se o backend est√° rodando
2. Verificar `enabled: true` na configura√ß√£o
3. Verificar `backendUrl` correto
4. Verificar logs do backend para erros de ingest√£o

### Performance Impact

O sistema √© otimizado para m√≠nimo impacto:

- Envio ass√≠ncrono (fire-and-forget)
- Buffer para falhas tempor√°rias
- Sanitiza√ß√£o eficiente
- Configur√°vel por tipo de evento

### Logs Excessivos

Ajustar n√≠vel de log:

```typescript
// No agent
const logger = new Logger(DevtoolsService.name);
logger.setLogLevels(['error', 'warn']); // Apenas erros e warnings
```

## üìö Refer√™ncias

- [Documenta√ß√£o Completa](./IMPLEMENTATION_SUMMARY.md)
- [Guia de Instala√ß√£o](./packages/agent/INSTALLATION.md)
- [Exemplos de Uso](./packages/agent/USAGE_EXAMPLE.md)
- [API Reference](./docs/api.md)

## üéØ Pr√≥ximos Passos

Ap√≥s configurar o sistema:

1. ‚úÖ Configurar o agent no seu app
2. ‚úÖ Habilitar os tracers necess√°rios
3. ‚úÖ Iniciar backend e frontend
4. ‚úÖ Gerar alguns eventos (fazer requisi√ß√µes, executar jobs, etc.)
5. ‚úÖ Visualizar no dashboard
6. ‚úÖ Configurar alertas (opcional)
7. ‚úÖ Integrar com CI/CD (opcional)

## üí° Dicas

- **Desenvolvimento:** Habilite todos os tracers para m√°xima visibilidade
- **Staging:** Habilite tracers cr√≠ticos (Schedule, HTTP Client)
- **Produ√ß√£o:** Desabilite ou use com muito cuidado (apenas erros cr√≠ticos)
- **Performance:** Desabilite `captureResponse` se responses forem muito grandes
- **Seguran√ßa:** Sempre configure `sensitiveFields` adequadamente

---

**Sistema desenvolvido com ‚ù§Ô∏è para facilitar o debugging e monitoramento de aplica√ß√µes NestJS**
