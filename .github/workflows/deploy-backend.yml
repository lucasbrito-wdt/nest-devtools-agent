name: ğŸš€ Deploy Backend (Railway)

on:
  push:
    branches:
      - main
      - master
      - staging
    paths:
      - 'packages/backend/**'
      - 'packages/shared/**'
      - 'Dockerfile'
      - 'railway.toml'
      - 'package.json'
      - 'bun.lockb'
  workflow_dispatch:

env:
  BUN_VERSION: '1.0.0'

jobs:
  deploy-backend:
    name: Deploy Backend to Railway
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ¥Ÿ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: ğŸ“¥ Instalar dependÃªncias
        run: bun install --frozen-lockfile

      - name: ğŸ—ï¸ Build shared package
        run: |
          cd packages/shared
          bun run build

      - name: ğŸ—ï¸ Build backend
        run: |
          cd packages/backend
          bun run build

      - name: ğŸ§ª Executar testes
        run: |
          cd packages/backend
          bun test
        continue-on-error: true

      - name: ğŸ” Type check
        run: |
          cd packages/backend
          bun run typecheck
        continue-on-error: true

      - name: ğŸš€ Deploy para Railway
        run: |
          echo "âœ… Build completo! Railway vai fazer deploy automaticamente via GitHub integration"
          echo "ğŸŒ Acesse: https://railway.app/dashboard"
          echo "ğŸ“‹ O Railway detecta automaticamente os pushes no branch master/main"

      - name: âœ… Notificar sucesso
        if: success()
        run: |
          echo "âœ… Backend build com sucesso!"
          echo "ğŸš‚ Railway vai fazer deploy automaticamente"
          echo "ğŸ“‹ Configure a integraÃ§Ã£o GitHub no Railway Dashboard"

      - name: âŒ Notificar falha
        if: failure()
        run: |
          echo "âŒ Build do backend falhou!"
          echo "ğŸ“‹ Verifique os logs acima para detalhes"
