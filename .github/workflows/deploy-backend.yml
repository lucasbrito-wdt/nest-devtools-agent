name: 🚀 Deploy Backend (Railway)

on:
  push:
    branches:
      - main
      - master
      - staging
    paths:
      - 'packages/backend/**'
      - 'packages/shared/**'
      - 'Dockerfile'
      - 'railway.toml'
      - 'package.json'
      - 'bun.lockb'
  workflow_dispatch:

env:
  BUN_VERSION: '1.0.0'

jobs:
  deploy-backend:
    name: Deploy Backend to Railway
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout código
        uses: actions/checkout@v4

      - name: 🥟 Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: 📥 Instalar dependências
        run: bun install --frozen-lockfile

      - name: 🏗️ Build shared package
        run: |
          cd packages/shared
          bun run build

      - name: 🏗️ Build backend
        run: |
          cd packages/backend
          bun run build

      - name: 🧪 Executar testes
        run: |
          cd packages/backend
          bun test
        continue-on-error: true

      - name: 🔍 Type check
        run: |
          cd packages/backend
          bun run typecheck
        continue-on-error: true

      - name: 🚀 Deploy para Railway
        run: |
          echo "✅ Build completo! Railway vai fazer deploy automaticamente via GitHub integration"
          echo "🌐 Acesse: https://railway.app/dashboard"
          echo "📋 O Railway detecta automaticamente os pushes no branch master/main"

      - name: ✅ Notificar sucesso
        if: success()
        run: |
          echo "✅ Backend build com sucesso!"
          echo "🚂 Railway vai fazer deploy automaticamente"
          echo "📋 Configure a integração GitHub no Railway Dashboard"

      - name: ❌ Notificar falha
        if: failure()
        run: |
          echo "❌ Build do backend falhou!"
          echo "📋 Verifique os logs acima para detalhes"
