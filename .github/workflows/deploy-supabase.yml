name: ðŸ—„ï¸ Deploy Supabase (Migrations)

on:
  push:
    branches:
      - main
    paths:
      - 'supabase/migrations/**'
      - 'init.sql'
  workflow_dispatch:

env:
  SUPABASE_CLI_VERSION: '1.127.4'

jobs:
  deploy-migrations:
    name: Deploy Database Migrations
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: ${{ env.SUPABASE_CLI_VERSION }}

      - name: ðŸ”— Link ao projeto Supabase
        run: |
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: ðŸ” Verificar status do banco
        run: supabase db diff
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        continue-on-error: true

      - name: ðŸš€ Aplicar migrations
        run: supabase db push
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: âœ… Verificar migrations aplicadas
        run: |
          echo "âœ… Migrations aplicadas com sucesso!"
          supabase migration list
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: ðŸ“Š Gerar types TypeScript
        run: |
          supabase gen types typescript --local > packages/shared/src/types/database.types.ts
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        continue-on-error: true

      - name: ðŸ’¾ Commit types gerados
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update database types from Supabase [skip ci]"
          file_pattern: "packages/shared/src/types/database.types.ts"
        continue-on-error: true

